stages:
  - build
  - deploy-staging
  - deploy-production

variables:
  DOCKER_IMAGE: gitlab-new.homelab.lan:5050/adam/timekpr-ui-frontend

# Build stage - runs on all branches
build-docker:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "Building Docker image for timekpr-ui-frontend"
    - /kaniko/executor
      --context $CI_PROJECT_DIR
      --dockerfile $CI_PROJECT_DIR/Dockerfile
      --destination $DOCKER_IMAGE:$CI_COMMIT_SHA
      --destination $DOCKER_IMAGE:latest
      --insecure
      --skip-tls-verify
      --single-snapshot
  tags:
    - kubernetes

# Deploy to staging - automatic on master branch
deploy-staging:
  stage: deploy-staging
  image: bitnami/kubectl:latest
  script:
    - |
      cat << EOF | kubectl apply -f -
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: timekpr-ui-frontend
        namespace: staging
        labels:
          app: timekpr-ui-frontend
          version: staging
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: timekpr-ui-frontend
        template:
          metadata:
            labels:
              app: timekpr-ui-frontend
          spec:
            imagePullSecrets:
            - name: timekpr-frontend-registry-secret
            containers:
            - name: timekpr-ui-frontend
              image: $DOCKER_IMAGE:$CI_COMMIT_SHA
              ports:
              - containerPort: 80
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "256Mi"
                  cpu: "200m"
              livenessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 30
                periodSeconds: 10
              readinessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 5
                periodSeconds: 5
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: timekpr-ui-frontend-service
        namespace: staging
      spec:
        selector:
          app: timekpr-ui-frontend
        ports:
        - port: 80
          targetPort: 80
        type: ClusterIP
      ---
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: timekpr-ui-frontend-ingress
        namespace: staging
        annotations:
          kubernetes.io/ingress.class: "traefik"
          traefik.ingress.kubernetes.io/priority: "1000"
      spec:
        rules:
        - host: timekpr-staging.homelab.lan
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: timekpr-ui-frontend-service
                  port:
                    number: 80
      EOF
    - echo "Deployed frontend to staging namespace"
    - kubectl get pods -n staging -l app=timekpr-ui-frontend
    - kubectl get svc -n staging timekpr-ui-frontend-service
    - kubectl get ingress -n staging timekpr-ui-frontend-ingress
  tags:
    - kubernetes
  only:
    - master
  environment:
    name: staging
    url: http://timekpr-staging.homelab.lan

# Deploy to production - manual on release branches
deploy-production:
  stage: deploy-production
  image: bitnami/kubectl:latest
  script:
    - |
      cat << EOF | kubectl apply -f -
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: timekpr-ui-frontend
        namespace: production
        labels:
          app: timekpr-ui-frontend
          version: production
      spec:
        replicas: 2
        selector:
          matchLabels:
            app: timekpr-ui-frontend
        template:
          metadata:
            labels:
              app: timekpr-ui-frontend
          spec:
            imagePullSecrets:
            - name: timekpr-frontend-registry-secret
            containers:
            - name: timekpr-ui-frontend
              image: $DOCKER_IMAGE:$CI_COMMIT_SHA
              ports:
              - containerPort: 80
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "300m"
              livenessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 30
                periodSeconds: 10
              readinessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 5
                periodSeconds: 5
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: timekpr-ui-frontend-service
        namespace: production
      spec:
        selector:
          app: timekpr-ui-frontend
        ports:
        - port: 80
          targetPort: 80
        type: ClusterIP
      ---
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: timekpr-ui-frontend-ingress
        namespace: production
        annotations:
          kubernetes.io/ingress.class: "traefik"
          traefik.ingress.kubernetes.io/priority: "1000"
      spec:
        rules:
        - host: timekpr.homelab.lan
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: timekpr-ui-frontend-service
                  port:
                    number: 80
      EOF
    - echo "Deployed frontend to production namespace - Release:" $CI_COMMIT_REF_NAME
    - kubectl get pods -n production -l app=timekpr-ui-frontend
    - kubectl get svc -n production timekpr-ui-frontend-service
    - kubectl get ingress -n production timekpr-ui-frontend-ingress
  tags:
    - kubernetes
  only:
    - /^release\/.*$/
  environment:
    name: production
    url: http://timekpr.homelab.lan
  when: manual